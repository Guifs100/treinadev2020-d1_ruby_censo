#!/usr/bin/env ruby

puts '== Installing dependencies =='
system 'gem install bundler --conservative'
system('bundle check') || system('bundle install')

require 'sqlite3'
require 'csv'


puts "\n== Preparing database =="

begin
  db = SQLite3::Database.open "db/database.db"
  db.execute <<-SQL
    CREATE TABLE IF NOT EXISTS Populacao(
      Nivel varchar(255),
      Cod int,
      Federacao varchar(255),
      Populacao int
    );
  SQL


  CSV.foreach('data/populacao_2019.csv', col_sep: ',').with_index do |linha, indice|
    unless (indice == 0)
      db.execute "INSERT INTO Populacao VALUES ( ?, ?, ?, ? )", linha
    end
  end



rescue SQLite3::Exception => e
  puts e
ensure
  db.close if db
end
puts '== Tudo configurado, pode iniciar ;) =='